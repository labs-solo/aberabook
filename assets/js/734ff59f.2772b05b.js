"use strict";(self.webpackChunkstrapi_docs=self.webpackChunkstrapi_docs||[]).push([[2534],{3905:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>m});var o=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,i=function(e,t){if(null==e)return{};var n,o,i={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var p=o.createContext({}),c=function(e){var t=o.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},s=function(e){var t=c(e.components);return o.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,p=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),u=c(n),m=i,h=u["".concat(p,".").concat(m)]||u[m]||d[m]||a;return n?o.createElement(h,r(r({ref:t},s),{},{components:n})):o.createElement(h,r({ref:t},s))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,r=new Array(a);r[0]=u;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var c=2;c<a;c++)r[c]=n[c];return o.createElement.apply(null,r)}return o.createElement.apply(null,n)}u.displayName="MDXCreateElement"},57836:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>r,default:()=>d,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var o=n(83117),i=(n(67294),n(3905));const a={title:"Policies",displayed_sidebar:"devDocsSidebar",description:"Migrate policies from Strapi v3.6.x to Strapi v4.0.x with step-by-step instructions"},r="v4 code migration: Updating policies",l={unversionedId:"dev-docs/migration/v3-to-v4/code/policies",id:"dev-docs/migration/v3-to-v4/code/policies",title:"Policies",description:"Migrate policies from Strapi v3.6.x to Strapi v4.0.x with step-by-step instructions",source:"@site/docs/dev-docs/migration/v3-to-v4/code/policies.md",sourceDirName:"dev-docs/migration/v3-to-v4/code",slug:"/dev-docs/migration/v3-to-v4/code/policies",permalink:"/aberabook/dev-docs/migration/v3-to-v4/code/policies",draft:!1,editUrl:"https://github.com/labs-solo/aberabook/edit/main/docusaurus/docs/dev-docs/migration/v3-to-v4/code/policies.md",tags:[],version:"current",frontMatter:{title:"Policies",displayed_sidebar:"devDocsSidebar",description:"Migrate policies from Strapi v3.6.x to Strapi v4.0.x with step-by-step instructions"},sidebar:"devDocsSidebar",previous:{title:"GraphQL resolvers",permalink:"/aberabook/dev-docs/migration/v3-to-v4/code/graphql"},next:{title:"Route middlewares",permalink:"/aberabook/dev-docs/migration/v3-to-v4/code/route-middlewares"}},p={},c=[],s={toc:c};function d(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,o.Z)({},s,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"v4-code-migration-updating-policies"},"v4 code migration: Updating policies"),(0,i.kt)("p",null,"This guide is part of the ",(0,i.kt)("a",{parentName:"p",href:"/aberabook/dev-docs/migration/v3-to-v4/code-migration"},"v4 code migration guide")," designed to help you migrate the code of a Strapi application from v3.6.x to v4.0.x"),(0,i.kt)("p",null,":::strapi v3/v4 comparison"),(0,i.kt)("p",null,"In both Strapi v3 and v4, policies handle authorization. Policies can be stored globally or scoped (i.e. with a specific API or plugin) and can be applied to REST controller's actions or to GraphQL resolvers."),(0,i.kt)("p",null,"In Strapi v3, policies are Koa middlewares accepting or rejecting requests based on the REST context. As middlewares, v3 policies always receive a Koa context, either coming from the REST request or built from the GraphQL resolver arguments."),(0,i.kt)("p",null,"In Strapi v4, ",(0,i.kt)("a",{parentName:"p",href:"/dev-docs/backend-customization/policies#policies"},"policies")," are functions that should return ",(0,i.kt)("inlineCode",{parentName:"p"},"true")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"undefined")," for the request to be accepted. v4 policies receive a custom context, that cannot be modified, based on where the policy has been called from (e.g. a REST controller\u2019s action or a GraphQL resolver)."),(0,i.kt)("p",null,"Strapi v3 policies acting as route middlewares should be converted to proper ",(0,i.kt)("a",{parentName:"p",href:"/dev-docs/migration/v3-to-v4/code/route-middlewares"},"v4 route middlewares"),".\n:::"),(0,i.kt)("p",null,"To migrate a policy to Strapi v4:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Move the policy file in the appropriate folder, depending on the policy scope:"),(0,i.kt)("table",{parentName:"li"},(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Policy scope"),(0,i.kt)("th",{parentName:"tr",align:null},"Folder"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Global"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"./src/policies"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"A specific API"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"./src/api/<api-name>/policies"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"A specific plugin"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"./src/plugins/<plugin-name>/policies"),(0,i.kt)("br",null),(0,i.kt)("br",null),"(see ",(0,i.kt)("a",{parentName:"td",href:"/dev-docs/migration/v3-to-v4/plugin/update-folder-structure#moving-policies"},"plugin policies migration")," documentation)"))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"(",(0,i.kt)("em",{parentName:"p"},"optional"),") Update the policy code. Strapi v4 policies are functions returning ",(0,i.kt)("inlineCode",{parentName:"p"},"true")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"undefined")," to authorize the request."))),(0,i.kt)("p",null,"Migrating a policy code depends on the code itself and this migration guide can't cover every existing use case. The following examples cover some common use cases of v4 policies working with both REST and GraphQL APIs or specifically with one of these APIs. These examples can be used for global, API-related, or plugin-related policies."),(0,i.kt)("details",null,(0,i.kt)("summary",null," Example: Authorize only logged in users (REST and GraphQL)"),(0,i.kt)("p",null,"The following v3 policy authorizes only logged in users:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"module.exports = async (ctx, next) => {\n  if (ctx.state.user) {\n    // Go to next policy or will reach the controller's action.\n    return await next();\n  }\n \n  ctx.unauthorized(`You're not logged in!`);\n};\n")),(0,i.kt)("p",null,"To update this policy to v4, replace it with the following code:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"module.exports = (policyContext, config, { strapi }) => {\n  if (policyContext.state.user) { // if a session is open\n    // go to next policy or reach the controller's action\n    return true;\n  }\n\n  return false; // If you return nothing, Strapi considers you didn't want to block the request and will let it pass\n};\n")),(0,i.kt)("p",null,"The v4 policy uses the ",(0,i.kt)("inlineCode",{parentName:"p"},"policyContext.state")," variable, accessible to both REST and GraphQL.")),(0,i.kt)("details",null,(0,i.kt)("summary",null," Example: Shared policy with alternate logic for REST and GraphQL"),(0,i.kt)("p",null,"The following v4 policy checks if the current request is coming from REST or GraphQL via the ",(0,i.kt)("inlineCode",{parentName:"p"},"policyContext.type")," and allows running alternative validation rules for each."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="path: ./src/policies or ./src/api/api-name/policies/  depending on where you want to apply the policy"',title:'"path:',"./src/policies":!0,or:!0,"./src/api/api-name/policies/":!0,"":!0,depending:!0,on:!0,where:!0,you:!0,want:!0,to:!0,apply:!0,the:!0,'policy"':!0},"\nmodule.exports = (policyContext, config, { strapi }) => {\n  // handle Koa\n  if (policyContext.type === 'koa') {\n    // Do REST validation\n    return true\n  }\n\n  // handle GraphQL\n  else if (policyContext.type === 'graphql') {\n    // Do GraphQL validation\n    return true\n  }\n\n  // handle other cases\n  return false;\n};\n"))),(0,i.kt)("details",null,(0,i.kt)("summary",null," Example: Authorize only for a specific entity (REST)"),(0,i.kt)("p",null,"The following policy code can be used to authorize only targeting a specific entity:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"module.exports = (policyContext, config, { strapi }) => {\n  return policyContext.params.id === 5;\n};\n"))),(0,i.kt)("details",null,(0,i.kt)("summary",null," Example: Authorize field resolvers only for a specific entity (GraphQL)"),(0,i.kt)("p",null,"The following policy code can be used to authorize field resolvers only targeting a specific entity:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"module.exports = (policyContext, config, { strapi }) => {\n  return typeof policyContext.parent === 'object' && policyContext.parent.id === 5;\n};\n"))),(0,i.kt)("admonition",{title:"Customization tips",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"In Strapi v4, depending on whether the policy is applied to REST or GraphQL (use ",(0,i.kt)("inlineCode",{parentName:"p"},"policyContext.type")," is either ",(0,i.kt)("inlineCode",{parentName:"p"},"koa")," for REST or ",(0,i.kt)("inlineCode",{parentName:"p"},"graphql")," ), the function has access to different contexts:"),(0,i.kt)("ul",{parentName:"admonition"},(0,i.kt)("li",{parentName:"ul"},"Both REST and GraphQL contexts have access to the ",(0,i.kt)("inlineCode",{parentName:"li"},"is"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"type"),", and ",(0,i.kt)("inlineCode",{parentName:"li"},"state"),"."),(0,i.kt)("li",{parentName:"ul"},"The REST context have access to the destructed Koa context."),(0,i.kt)("li",{parentName:"ul"},"The GraphQL context has access to ",(0,i.kt)("inlineCode",{parentName:"li"},"parent"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"args"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"context")," (which is the GraphQL Context), ",(0,i.kt)("inlineCode",{parentName:"li"},"info")," & ",(0,i.kt)("inlineCode",{parentName:"li"},"http")," (which contains the Koa context) (see ",(0,i.kt)("a",{parentName:"li",href:"/dev-docs/plugins/graphql#custom-configuration-for-resolvers"},"GraphQL customization")," documentation).")),(0,i.kt)("p",{parentName:"admonition"},"You can use ",(0,i.kt)("inlineCode",{parentName:"p"},"policyContext.type"),", which value is either ",(0,i.kt)("inlineCode",{parentName:"p"},"koa")," for REST or ",(0,i.kt)("inlineCode",{parentName:"p"},"graphql")," for the GraphQL plugin, to determine the type of context the policy uses.")))}d.isMDXComponent=!0}}]);