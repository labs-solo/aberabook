"use strict";(self.webpackChunkstrapi_docs=self.webpackChunkstrapi_docs||[]).push([[1130],{3905:(e,t,a)=>{a.d(t,{Zo:()=>m,kt:()=>u});var n=a(67294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var p=n.createContext({}),s=function(e){var t=n.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},m=function(e){var t=s(e.components);return n.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,p=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),c=s(a),u=o,g=c["".concat(p,".").concat(u)]||c[u]||d[u]||r;return a?n.createElement(g,i(i({ref:t},m),{},{components:a})):n.createElement(g,i({ref:t},m))}));function u(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,i=new Array(r);i[0]=c;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var s=2;s<r;s++)i[s]=a[s];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},92332:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>f,frontMatter:()=>r,metadata:()=>l,toc:()=>s});var n=a(83117),o=(a(67294),a(3905));const r={title:"MongoDB v3 to SQL v3 migration",description:"Migrate from a MongoDB to a SQL database in Strapi v3",displayed_sidebar:"devDocsSidebar"},i=void 0,l={unversionedId:"dev-docs/migration/v3-to-v4/data/mongo",id:"dev-docs/migration/v3-to-v4/data/mongo",title:"MongoDB v3 to SQL v3 migration",description:"Migrate from a MongoDB to a SQL database in Strapi v3",source:"@site/docs/dev-docs/migration/v3-to-v4/data/mongo.md",sourceDirName:"dev-docs/migration/v3-to-v4/data",slug:"/dev-docs/migration/v3-to-v4/data/mongo",permalink:"/aberabook/dev-docs/migration/v3-to-v4/data/mongo",draft:!1,editUrl:"https://github.com/labs-solo/aberabook/edit/main/docusaurus/docs/dev-docs/migration/v3-to-v4/data/mongo.md",tags:[],version:"current",frontMatter:{title:"MongoDB v3 to SQL v3 migration",description:"Migrate from a MongoDB to a SQL database in Strapi v3",displayed_sidebar:"devDocsSidebar"},sidebar:"devDocsSidebar",previous:{title:"SQL relations cheatsheet",permalink:"/aberabook/dev-docs/migration/v3-to-v4/data/sql-relations"},next:{title:"MongoDB vs. SQL cheatsheet",permalink:"/aberabook/dev-docs/migration/v3-to-v4/data/mongo-sql-cheatsheet"}},p={},s=[{value:"Prepare the migration locally",id:"prepare-the-migration-locally",level:2},{value:"Migrate the data locally",id:"migrate-the-data-locally",level:2},{value:"Migrate the local data to production",id:"migrate-the-local-data-to-production",level:2}],m=e=>function(t){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),(0,o.kt)("div",t)},d=m("Columns"),c=m("ColumnLeft"),u=m("ColumnRight"),g=m("Tabs"),h=m("TabItem"),k={toc:s};function f(e){let{components:t,...a}=e;return(0,o.kt)("wrapper",(0,n.Z)({},k,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"migrate-from-mongodb-to-sql-with-strapi-v3"},"Migrate from MongoDB to SQL with Strapi v3"),(0,o.kt)("p",null,"Strapi v4 does not support MongoDB databases (see ",(0,o.kt)("a",{parentName:"p",href:"https://strapi.io/blog/mongo-db-support-in-strapi-past-present-and-future"},"blog post announcement"),")."),(0,o.kt)("p",null,"If your Strapi v3 project uses a MongoDB database, migrating from Strapi v3 to Strapi v4 is a 2-step process: first, migrate from MongoDB to SQL within Strapi v3, and then migrate the SQL database from Strapi v3 to Strapi v4."),(0,o.kt)("p",null,"Migrating from MongoDB to SQL with Strapi v3 requires:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"#prepare-the-migration-locally"},"preparing the migration locally"),","),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"#migrate-the-data-locally"},"migrating the data locally"),","),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"#migrate-the-local-data-to-production"},"migrating the local data to production"),".")),(0,o.kt)("h2",{id:"prepare-the-migration-locally"},"Prepare the migration locally"),(0,o.kt)("p",null,"To prepare the migration locally:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Dump the MongoDB database (see ",(0,o.kt)("a",{parentName:"p",href:"https://www.mongodb.com/docs/database-tools/mongodump/"},"MongoDB official documentation"),") and load it locally.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"(",(0,o.kt)("em",{parentName:"p"},"optional, only if not migrating to SQLite"),") Create a SQL database locally."),(0,o.kt)("admonition",{parentName:"li",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"To avoid installing SQL and MongoDB on your computer, you can setup the local Mongo and SQL databases using a ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/"},"Docker")," image."))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Switch the application connector to bookshelf and configure it with the previously created databases:"),(0,o.kt)("p",{parentName:"li"},"a. Add the required dependencies:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"\n## install the bookshelf connector\nnpm install strapi-connector-bookshelf@3.6.9 knex@0.21.19\n\n# install the appropriate database driver\n# for SQLite\nnpm install sqlite3@5.0.2\n# for PostgreSQL\nnpm install pg@8.7.3\n# for MySQL\nnpm install mysql@2.18.1\n")),(0,o.kt)("p",{parentName:"li"},"b. Update the configuration in  ",(0,o.kt)("inlineCode",{parentName:"p"},"./config/database.js"),":"),(0,o.kt)(d,{mdxType:"Columns"},(0,o.kt)(c,{title:"Before, with a MongoDB database:",mdxType:"ColumnLeft"},(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-jsx"},"// before\n{\n  connector: 'mongoose',\n  settings: {\n    database: 'strapi',\n    username: 'strapi',\n    password: 'strapi',\n    port: 27017,\n    host: 'localhost',\n  },\n  options: {},\n}\n\n"))),(0,o.kt)(u,{title:"After, with a SQL database:",mdxType:"ColumnRight"},(0,o.kt)(g,{mdxType:"Tabs"},(0,o.kt)(h,{value:"sqlite",title:"SQLite",mdxType:"TabItem"},(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// after\nmodule.exports = ({ env }) => ({\n  defaultConnection: 'default',\n  connections: {\n    default: {\n      connector: 'bookshelf',\n      settings: {\n        client: 'sqlite',\n        filename: env('DATABASE_FILENAME', '.tmp/data.db'),\n      },\n      options: {\n        useNullAsDefault: true,\n      },\n    },\n  },\n});\n"))),(0,o.kt)(h,{value:"postgresql",title:"PostgreSQL",mdxType:"TabItem"},(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// after\nmodule.exports = ({ env }) => ({\n  defaultConnection: 'default',\n  connections: {\n    default: {\n      connector: 'bookshelf',\n      settings: {\n        client: 'postgres',\n        database: 'strapi',\n        username: 'strapi',\n        password: 'strapi',\n        port: 5432,\n        host: 'localhost',\n      },\n      options: {},\n    },\n  },\n});\n"))),(0,o.kt)(h,{value:"mysql",title:"MySQL",mdxType:"TabItem"},(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// after\nmodule.exports = ({ env }) => ({\n  defaultConnection: 'default',\n  connections: {\n    default: {\n      connector: 'bookshelf',\n      settings: {\n        client: 'mysql',\n        database: 'strapi',\n        username: 'strapi',\n        password: 'strapi',\n        port: 3306,\n        host: 'localhost',\n      },\n      options: {},\n    },\n  },\n});\n"))))))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Start the application locally to generate the SQL schema and default values in the database.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Shut down the application.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Truncate every table and reset primary keys to only keep the structure, using the following queries, depending on the database type:"),(0,o.kt)(g,{mdxType:"Tabs"},(0,o.kt)(h,{value:"sqlite",title:"SQLite",mdxType:"TabItem"},(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"// truncate\nDELETE FROM tableA;\nDELETE FROM tableB;\n\n// reset sequences\nDELETE FROM sqlite_sequence \nWHERE name IN ('table_a', 'table_b', '...');\n"))),(0,o.kt)(h,{value:"postgresql",title:"PostgreSQL",mdxType:"TabItem"},(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"TRUNCATE tableA, tableB, tableC RESTART IDENTITY CASCADE;\n"))),(0,o.kt)(h,{value:"mysql",title:"MySQL",mdxType:"TabItem"},(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"// truncate\nSET FOREIGN_KEY_CHECKS = 0;\n\nTRUNCATE tableA;\nTRUNCATE tableB;\n\nSET FOREIGN_KEY_CHECKS = 1;\n")))))),(0,o.kt)("h2",{id:"migrate-the-data-locally"},"Migrate the data locally"),(0,o.kt)("p",null,"To migrate the data locally:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"either build your own script based on the differences between MongoDB and SQL implementations (see ",(0,o.kt)("a",{parentName:"p",href:"/dev-docs/migration/v3-to-v4/data/mongo-sql-cheatsheet"},"cheatsheet"),"), using the following advice:"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"On the 1st pass:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Create all the entries without relations/components links."),(0,o.kt)("li",{parentName:"ul"},"Create a mapping from MongoDB ids to SQL ids."))),(0,o.kt)("li",{parentName:"ul"},"and on the 2nd pass, create the relations/components links based on the MongoDB to SQL ids mapping."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"or use a migration tool, like ",(0,o.kt)("a",{parentName:"p",href:"https://studio3t.com/knowledge-base/articles/mongodb-to-sql-migration/#mappings"},"the Studio3T tutorial"),", taking into account the differences between MongoDB and SQL implementations (see ",(0,o.kt)("a",{parentName:"p",href:"/dev-docs/migration/v3-to-v4/data/mongo-sql-cheatsheet"},"cheatsheet"),")."))),(0,o.kt)("h2",{id:"migrate-the-local-data-to-production"},"Migrate the local data to production"),(0,o.kt)("p",null,"To migrate the local data to the production database:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Dump the SQL data migrated locally.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Import the dump into the production database.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Deploy the application with the updated connector (see ",(0,o.kt)("a",{parentName:"p",href:"#prepare-the-migration-locally"},"prepare the migration locally")," for configuration details)."))),(0,o.kt)("p",null,":::strapi Next steps\nIf the present guide was used to migrate from Strapi v3 to Strapi v4, the next step in the data migration process is to proceed to the ",(0,o.kt)("a",{parentName:"p",href:"/dev-docs/migration/v3-to-v4/data/sql"},"SQL migration from Strapi v3 to Strapi v4"),".\n:::"))}f.isMDXComponent=!0}}]);