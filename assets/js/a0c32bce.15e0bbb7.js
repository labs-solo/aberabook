"use strict";(self.webpackChunkstrapi_docs=self.webpackChunkstrapi_docs||[]).push([[3855],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>u});var n=a(67294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=n.createContext({}),m=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=m(e.components);return n.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=m(a),u=i,g=c["".concat(l,".").concat(u)]||c[u]||d[u]||r;return a?n.createElement(g,o(o({ref:t},p),{},{components:a})):n.createElement(g,o({ref:t},p))}));function u(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,o=new Array(r);o[0]=c;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var m=2;m<r;m++)o[m]=a[m];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},28362:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>m});var n=a(83117),i=(a(67294),a(3905));const r={title:"Database migrations",description:"Strapi database migrations are ways to modify the database"},o="Database migrations",s={unversionedId:"dev-docs/database-migrations",id:"dev-docs/database-migrations",title:"Database migrations",description:"Strapi database migrations are ways to modify the database",source:"@site/docs/dev-docs/database-migrations.md",sourceDirName:"dev-docs",slug:"/dev-docs/database-migrations",permalink:"/dev-docs/database-migrations",draft:!1,editUrl:"https://github.com/labs-solo/aberabook/edit/main/docusaurus/docs/dev-docs/database-migrations.md",tags:[],version:"current",frontMatter:{title:"Database migrations",description:"Strapi database migrations are ways to modify the database"}},l={},m=[{value:"Understanding database migration files",id:"understanding-database-migration-files",level:2},{value:"Creating a migration file",id:"creating-a-migration-file",level:2},{value:"Using Strapi Instance for migrations",id:"using-strapi-instance-for-migrations",level:3}],p={toc:m};function d(e){let{components:t,...a}=e;return(0,i.kt)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"database-migrations"},"Database migrations"),(0,i.kt)("p",null,"Database migrations exist to run one-time queries against the database, typically to modify the tables structure or the data when upgrading the Strapi application. These migrations are run automatically when the application starts and are executed before the automated schema migrations that Strapi also performs on boot."),(0,i.kt)("admonition",{title:"\ud83d\udea7  Experimental feature",type:"callout"},(0,i.kt)("p",{parentName:"admonition"},"Database migrations are experimental. This feature is still a work in progress and will continue to be updated and improved. In the meantime, feel free to ask for help on the ",(0,i.kt)("a",{parentName:"p",href:"https://forum.strapi.io/"},"forum")," or on the community ",(0,i.kt)("a",{parentName:"p",href:"https://discord.strapi.io"},"Discord"),".")),(0,i.kt)("h2",{id:"understanding-database-migration-files"},"Understanding database migration files"),(0,i.kt)("p",null,"Migrations are run using JavaScript migration files stored in ",(0,i.kt)("inlineCode",{parentName:"p"},"./database/migrations"),"."),(0,i.kt)("p",null,"Strapi automatically detects migration files and run them once at the next startup in alphabetical order. Every new file is executed once. Migrations are run before the database tables are synced with the content-types schemas."),(0,i.kt)("admonition",{type:"warning"},(0,i.kt)("ul",{parentName:"admonition"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Currently Strapi does not support down migrations. This means that if you need to revert a migration, you will have to do it manually. It is planned to implement down migrations in the future but no timeline is currently available.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Strapi will delete any unknown tables without warning. This means that database migrations can only be used to keep data when changing the Strapi schema. The ",(0,i.kt)("inlineCode",{parentName:"p"},"forceMigration")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"runMigrations")," ",(0,i.kt)("a",{parentName:"p",href:"/dev-docs/configurations/database#settings-configuration-object"},"database configuration parameters")," can be used to fine-tune the database migrations behavior.")))),(0,i.kt)("p",null,"Migration files should export the function ",(0,i.kt)("inlineCode",{parentName:"p"},"up()"),", which is used when upgrading (e.g. adding a new table ",(0,i.kt)("inlineCode",{parentName:"p"},"my_new_table"),")."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"up()")," function runs in a database transaction which means if a query fails during the migration, the whole migration is cancelled, and no changes are applied to the database. If another transaction is created within the migration function, it will act as a nested transaction."),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"There is no CLI to manually execute the database migrations.")),(0,i.kt)("h2",{id:"creating-a-migration-file"},"Creating a migration file"),(0,i.kt)("p",null,"To create a migration file:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"In the ",(0,i.kt)("inlineCode",{parentName:"p"},"./database/migrations")," folder, create a new file named after the date and the name of the migration (e.g. ",(0,i.kt)("inlineCode",{parentName:"p"},"2022.05.10T00.00.00.name-of-my-migration.js"),"). Make sure that the file name follows this naming pattern, because the alphabetical order of the files defines the order in which the migrations have to run.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Copy and paste the following template in the previously created file:"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"'use strict'\n\nasync function up(knex) {}\n\nmodule.exports = { up };\n")),(0,i.kt)("ol",{start:3},(0,i.kt)("li",{parentName:"ol"},"Fill in the template by adding actual migration code inside the ",(0,i.kt)("inlineCode",{parentName:"li"},"up()")," function.\n",(0,i.kt)("inlineCode",{parentName:"li"},"up()")," receives a ",(0,i.kt)("a",{parentName:"li",href:"https://knexjs.org/"},"Knex instance"),", already in a transaction state, that can be used to run the database queries.")),(0,i.kt)("details",null,(0,i.kt)("summary",null,"Example of migration file"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="./database/migrations/2022.05.10T00.00.00.name-of-my-migration.js"',title:'"./database/migrations/2022.05.10T00.00.00.name-of-my-migration.js"'},"\nmodule.exports = {\n  async up(knex) {\n    // You have full access to the Knex.js API with an already initialized connection to the database\n\n    // Example: renaming a table\n    await knex.schema.renameTable('oldName', 'newName');\n\n    // Example: renaming a column\n    await knex.schema.table('someTable', table => {\n      table.renameColumn('oldName', 'newName');\n    });\n\n    // Example: updating data\n    await knex.from('someTable').update({ columnName: 'newValue' }).where({ columnName: 'oldValue' });\n  },\n};\n"))),(0,i.kt)("h3",{id:"using-strapi-instance-for-migrations"},"Using Strapi Instance for migrations"),(0,i.kt)("admonition",{type:"danger"},(0,i.kt)("p",{parentName:"admonition"},"If a user opts not to use Knex directly for migrations and instead utilizes the Strapi instance, it is important to wrap the migration code with ",(0,i.kt)("inlineCode",{parentName:"p"},"strapi.db.transaction()"),". Failure to do so may result in migrations not rolling back if an error occurs.")),(0,i.kt)("details",null,(0,i.kt)("summary",null,"Example of migration file with Strapi instance"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="./database/migrations/2022.05.10T00.00.00.name-of-my-migration.js"',title:'"./database/migrations/2022.05.10T00.00.00.name-of-my-migration.js"'},"module.exports = {\n  async up() {\n    await strapi.db.transaction(async () => {\n      // Your migration code here\n\n      // Example: creating new entries\n      await strapi.entityService.create('api::article.article', {\n        data: {\n          title: 'My Article',\n        },\n      });\n\n      // Example: custom service method\n      await strapi.service('api::article.article').updateRelatedArticles();\n    });\n  },\n};\n"))))}d.isMDXComponent=!0}}]);