"use strict";(self.webpackChunkstrapi_docs=self.webpackChunkstrapi_docs||[]).push([[9662],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>u});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=c(n),u=r,h=m["".concat(l,".").concat(u)]||m[u]||d[u]||i;return n?a.createElement(h,o(o({ref:t},p),{},{components:n})):a.createElement(h,o({ref:t},p))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},40768:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>f,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var a=n(83117),r=(n(67294),n(3905));const i={title:"Custom services and controllers",description:"Learn how to authenticate use custom services and controllers using our FoodAdvisor example",displayed_sidebar:"devDocsSidebar",pagination_prev:"dev-docs/backend-customization/examples/authentication",pagination_next:"dev-docs/backend-customization/examples/policies"},o="Examples cookbook: Custom services and controllers",s={unversionedId:"dev-docs/backend-customization/examples/services-and-controllers",id:"dev-docs/backend-customization/examples/services-and-controllers",title:"Custom services and controllers",description:"Learn how to authenticate use custom services and controllers using our FoodAdvisor example",source:"@site/docs/dev-docs/backend-customization/examples/services-and-controllers.md",sourceDirName:"dev-docs/backend-customization/examples",slug:"/dev-docs/backend-customization/examples/services-and-controllers",permalink:"/aberabook/dev-docs/backend-customization/examples/services-and-controllers",draft:!1,editUrl:"https://github.com/labs-solo/aberabook/edit/main/docusaurus/docs/dev-docs/backend-customization/examples/services-and-controllers.md",tags:[],version:"current",frontMatter:{title:"Custom services and controllers",description:"Learn how to authenticate use custom services and controllers using our FoodAdvisor example",displayed_sidebar:"devDocsSidebar",pagination_prev:"dev-docs/backend-customization/examples/authentication",pagination_next:"dev-docs/backend-customization/examples/policies"},sidebar:"devDocsSidebar",previous:{title:"Authentication flow with JWT",permalink:"/aberabook/dev-docs/backend-customization/examples/authentication"},next:{title:"Custom policies",permalink:"/aberabook/dev-docs/backend-customization/examples/policies"}},l={},c=[{value:"REST API queries from the front end",id:"rest-api-queries-from-the-front-end",level:3},{value:"Controllers vs. Services",id:"controllers-vs-services",level:3},{value:"Custom service: Creating a review",id:"custom-service-creating-a-review",level:3},{value:"Custom Service: Sending an email to the restaurant owner",id:"custom-service-sending-an-email-to-the-restaurant-owner",level:3},{value:"Custom controller",id:"custom-controller",level:3}],p=e=>function(t){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),(0,r.kt)("div",t)},d=p("SideBySideContainer"),m=p("SideBySideColumn"),u=p("SubtleCallout"),h=p("Tabs"),v=p("TabItem"),k={toc:c};function f(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},k,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"examples-cookbook-custom-services-and-controllers"},"Examples cookbook: Custom services and controllers"),(0,r.kt)("admonition",{type:"prerequisites"},(0,r.kt)("p",{parentName:"admonition"},"This page is part of the back end customization examples cookbook. Please ensure you've read its ",(0,r.kt)("a",{parentName:"p",href:"/dev-docs/backend-customization/examples"},"introduction"),".")),(0,r.kt)("p",null,"From the front-end website of ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/strapi/foodadvisor"},"FoodAdvisor"),", you can browse a list of restaurants accessible at ",(0,r.kt)("a",{parentName:"p",href:"http://localhost:3000/restaurants"},(0,r.kt)("inlineCode",{parentName:"a"},"localhost:3000/restaurants")),". Clicking on any restaurant from the list will use the code included in the ",(0,r.kt)("inlineCode",{parentName:"p"},"/client")," folder to display additional information about this restaurant. The content displayed on a restaurant page was created within Strapi's Content Manager and is retrieved by querying Strapi's REST API which uses code included in the ",(0,r.kt)("inlineCode",{parentName:"p"},"/api")," folder."),(0,r.kt)("p",null,"This page will teach about the following advanced topics:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Topic"),(0,r.kt)("th",{parentName:"tr",align:null},"Section"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Create a component that interacts with the backend of Strapi"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"#rest-api-queries-from-the-front-end"},"REST API queries from the front-end"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Understand how services and controllers can play together"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"#controllers-vs-services"},"Controllers vs. services"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Create custom services"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("ul",null,(0,r.kt)("li",null,"A ",(0,r.kt)("a",{parentName:"td",href:"#custom-service-creating-a-review"},"custom service")," that only uses the Entity Service API"),(0,r.kt)("li",null,"Another more ",(0,r.kt)("a",{parentName:"td",href:"#custom-service-sending-an-email-to-the-restaurant-owner"},"advanced custom service")," that uses both Entity Service API and a Strapi plugin")))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Use services in a controller"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"#custom-controller"},"Custom controller"))))),(0,r.kt)("br",null),(0,r.kt)("h3",{id:"rest-api-queries-from-the-front-end"},"REST API queries from the front end"),(0,r.kt)(d,{mdxType:"SideBySideContainer"},(0,r.kt)(m,{mdxType:"SideBySideColumn"},(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\ud83d\udcad Context:")),(0,r.kt)("p",null,"Restaurant pages on the front-end website of ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/strapi/foodadvisor"},"FoodAdvisor"),' include a Reviews section that is read-only. Adding reviews requires logging in to Strapi\'s admin panel and adding content to the "Reviews" collection type through the ',(0,r.kt)("a",{parentName:"p",href:"/user-docs/content-manager"},"Content Manager"),"."),(0,r.kt)("p",null,"Let's add a small front-end component to restaurant pages. This component will allow a user to write a review directly from the front-end website.")),(0,r.kt)(m,{mdxType:"SideBySideColumn"},(0,r.kt)("figure",{style:{width:"100%",margin:"0"}},(0,r.kt)("img",{src:"/img/assets/backend-customization/tutorial-write-review.png",alt:"Writing a review on the front end"}),(0,r.kt)("em",null,(0,r.kt)("figcaption",{style:{fontSize:"12px"}},"A possible example of a form allowing users to submit a new review on a restaurant's page of the front-end website of FoodAdvisor"))))),(0,r.kt)(d,{mdxType:"SideBySideContainer"},(0,r.kt)(m,{mdxType:"SideBySideColumn"},(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\ud83c\udfaf Goals"),":"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Add a form to write a review."),(0,r.kt)("li",{parentName:"ul"},"Display the form on any restaurants page."),(0,r.kt)("li",{parentName:"ul"},"Send a POST request to Strapi's REST API when the form is submitted."),(0,r.kt)("li",{parentName:"ul"},"Use the ",(0,r.kt)("a",{parentName:"li",href:"#authentication-flow-with-jwt"},"previously stored JWT")," to authenticate the request."))),(0,r.kt)(m,{mdxType:"SideBySideColumn"},(0,r.kt)(u,{title:"Related concept",mdxType:"SubtleCallout"},(0,r.kt)("p",null,"Additional information on endpoints for content types can be found in the ",(0,r.kt)("a",{parentName:"p",href:"/dev-docs/api/rest#endpoints"},"REST API")," documentation.")))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\ud83e\uddd1\u200d\ud83d\udcbb Code example:")),(0,r.kt)("p",null,"In the ",(0,r.kt)("inlineCode",{parentName:"p"},"/client")," folder of the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/strapi/foodadvisor"},"FoodAdvisor")," project, you could use the following code examples to:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"create a new ",(0,r.kt)("inlineCode",{parentName:"li"},"pages/restaurant/RestaurantContent/Reviews/new-review.js")," file,"),(0,r.kt)("li",{parentName:"ul"},"and update the existing ",(0,r.kt)("inlineCode",{parentName:"li"},"components/pages/restaurant/RestaurantContent/Reviews/reviews.js"),".")),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Example front-end code to add a component for writing reviews and display it on restaurants pages:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create a new file in the ",(0,r.kt)("inlineCode",{parentName:"p"},"/client")," folder to add a new component for writing reviews with the following code:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title='/client/components/pages/restaurant/RestaurantContent/Reviews/new-review.js'",title:"'/client/components/pages/restaurant/RestaurantContent/Reviews/new-review.js'"},"\nimport { Button, Input, Textarea } from '@nextui-org/react';\nimport { useFormik } from 'formik';\nimport { useRouter } from 'next/router';\nimport React from 'react';\nimport { getStrapiURL } from '../../../../../utils';\n\nconst NewReview = () => {\n  const router = useRouter();\n\n  const { handleSubmit, handleChange, values } = useFormik({\n    initialValues: {\n      note: '',\n      content: '',\n    },\n    onSubmit: async (values) => {\n      /**\n       * Queries Strapi REST API to reach the reviews endpoint\n       * using the JWT previously stored in localStorage to authenticate\n       */\n      const res = await fetch(getStrapiURL('/reviews'), {\n        method: 'POST',\n        body: JSON.stringify({\n          restaurant: router.query.slug,\n          ...values,\n        }),\n        headers: {\n          Authorization: `Bearer ${localStorage.getItem('token')}`,\n          'Content-Type': 'application/json',\n        },\n      });\n    },\n  });\n  /**\n   * Renders the form\n   */\n  return (\n    <div className=\"my-6\">\n      <h1 className=\"font-bold text-2xl mb-3\">Write your review</h1>\n      <form onSubmit={handleSubmit} className=\"flex flex-col gap-y-4\">\n        <Input\n          onChange={handleChange}\n          name=\"note\"\n          type=\"number\"\n          min={1}\n          max={5}\n          label=\"Stars\"\n        />\n        <Textarea\n          name=\"content\"\n          onChange={handleChange}\n          placeholder=\"What do you think about this restaurant?\"\n        />\n        <Button\n          type=\"submit\"\n          className=\"bg-primary text-white rounded-md self-start\"\n        >\n          Send\n        </Button>\n      </form>\n    </div>\n  );\n};\n\nexport default NewReview;\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Display the new form component on any restaurants page by adding the highlighted lines (7, 8, and 13) to the code used to render restaurant's information:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title='/client/components/pages/restaurant/RestaurantContent/Reviews/reviews.js' showLineNumbers",title:"'/client/components/pages/restaurant/RestaurantContent/Reviews/reviews.js'",showLineNumbers:!0},"import React from 'react';\nimport delve from 'dlv';\n\nimport { formatDistance } from 'date-fns';\n\nimport { getStrapiMedia } from '../../../../../utils';\n// highlight-start\nimport { Textarea } from '@nextui-org/react';\nimport NewReview from './new-review';\n// highlight-end\n\nconst Reviews = ({ reviews }) => {\n  return (\n    <div className=\"col-start-2 col-end-2 mt-24\">\n      // highlight-next-line\n      <NewReview />\n      {reviews &&\n        reviews.map((review, index) => (\n  // \u2026\n"))))),(0,r.kt)("br",null),(0,r.kt)("h3",{id:"controllers-vs-services"},"Controllers vs. Services"),(0,r.kt)("p",null,"Controllers could contain any business logic to be executed when the client requests a route. However, as your code grows bigger and becomes more structured, it is a best practice to split the logic into specific services that do only one thing well, then call the services from controllers."),(0,r.kt)("p",null,"To illustrate the use of services, in this documentation the custom controller does not handle any responsibilities and delegates all the business logic to services."),(0,r.kt)("p",null,"Let's say we would like to customize the back end of ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/strapi/foodadvisor"},"FoodAdvisor")," to achieve the following scenario: when submitting the ",(0,r.kt)("a",{parentName:"p",href:"#rest-api-queries-from-the-front-end"},"previously added review form")," on the front-end website, Strapi will create a review in the back end and notify the restaurant owner by email. Translating this to Strapi back end customization means performing 3 actions:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Creating a custom service to ",(0,r.kt)("a",{parentName:"li",href:"#custom-service-creating-a-review"},"create the review"),"."),(0,r.kt)("li",{parentName:"ol"},"Creating a custom service to ",(0,r.kt)("a",{parentName:"li",href:"#custom-service-sending-an-email-to-the-restaurant-owner"},"send an email"),"."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"#custom-controller"},"Customizing the default controller")," provided by Strapi for the Review content-type to use the 2 new services.")),(0,r.kt)("br",null),(0,r.kt)("h3",{id:"custom-service-creating-a-review"},"Custom service: Creating a review"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\ud83d\udcad Context:")),(0,r.kt)("p",null,"By default, service files in Strapi includes basic boilerplate code that use the ",(0,r.kt)("inlineCode",{parentName:"p"},"createCoreService")," factory function."),(0,r.kt)("p",null,"Let's update the existing ",(0,r.kt)("inlineCode",{parentName:"p"},"review.js"),' service file for the "Reviews" collection type of ',(0,r.kt)("a",{parentName:"p",href:"https://github.com/strapi/foodadvisor"},"FoodAdvisor")," by replacing its code to create a review."),(0,r.kt)(d,{mdxType:"SideBySideContainer"},(0,r.kt)(m,{mdxType:"SideBySideColumn"},(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\ud83c\udfaf Goals"),":"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Declare a ",(0,r.kt)("inlineCode",{parentName:"li"},"create")," method."),(0,r.kt)("li",{parentName:"ul"},"Grab context from the request."),(0,r.kt)("li",{parentName:"ul"},"Use the ",(0,r.kt)("inlineCode",{parentName:"li"},"findMany()")," method from the EntityService API to find a restaurant."),(0,r.kt)("li",{parentName:"ul"},"Use the ",(0,r.kt)("inlineCode",{parentName:"li"},"create()")," method from the EntityService API to append data to the restaurant, populating the restaurant owner."),(0,r.kt)("li",{parentName:"ul"},"Return the new review data.\n"))),(0,r.kt)(m,{mdxType:"SideBySideColumn"},(0,r.kt)(u,{title:"Related concepts",mdxType:"SubtleCallout"},(0,r.kt)("p",null,"Additional information can be found in the ",(0,r.kt)("a",{parentName:"p",href:"/dev-docs/backend-customization/requests-responses"},"request context"),", ",(0,r.kt)("a",{parentName:"p",href:"/dev-docs/backend-customization/services"},"services")," and ",(0,r.kt)("a",{parentName:"p",href:"/dev-docs/api/entity-service"},"EntityService API")," documentation.")))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\ud83e\uddd1\u200d\ud83d\udcbb Code example:")),(0,r.kt)("p",null,"To create such a service, in the ",(0,r.kt)("inlineCode",{parentName:"p"},"/api")," folder of the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/strapi/foodadvisor"},"FoodAdvisor")," project, replace the content of the ",(0,r.kt)("inlineCode",{parentName:"p"},"src/api/review/services/review.js")," file with the following code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="src/api/review/services/review.js"',title:'"src/api/review/services/review.js"'},"const { createCoreService } = require('@strapi/strapi').factories;\n\nmodule.exports = createCoreService('api::review.review', ({ strapi }) => ({\n  async create(ctx) {\n    const user = ctx.state.user;\n    const { body } = ctx.request;\n\n    /**\n     * Queries the Restaurants collection type\n     * using the Entity Service API\n     * to retrieve information about the restaurant.\n     */\n    const restaurants = await strapi.entityService.findMany(\n      'api::restaurant.restaurant',\n      {\n        filters: {\n          slug: body.restaurant,\n        },\n      }\n    );\n\n    /**\n     * Creates a new entry for the Reviews collection type\n     * and populates data with information about the restaurant's owner\n     * using the Entity Service API.\n     */\n    const newReview = await strapi.entityService.create('api::review.review', {\n      data: {\n        note: body.note,\n        content: body.content,\n        restaurant: restaurants[0].id,\n        author: user.id,\n      },\n      populate: ['restaurant.owner'],\n    });\n\n    return newReview;\n  },\n}));\n")),(0,r.kt)("admonition",{title:"Tips",type:"tip"},(0,r.kt)("ul",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ul"},"In a controller's code, the ",(0,r.kt)("inlineCode",{parentName:"li"},"create")," method from this service can be called with ",(0,r.kt)("inlineCode",{parentName:"li"},"strapi.service('api::review.review').create(ctx)")," where ",(0,r.kt)("inlineCode",{parentName:"li"},"ctx")," is the request's ",(0,r.kt)("a",{parentName:"li",href:"/dev-docs/backend-customization/requests-responses"},"context"),"."),(0,r.kt)("li",{parentName:"ul"},"The provided example code does not cover error handling. You should consider handling errors, for instance when the restaurant does not exist. Additional information can be found in the ",(0,r.kt)("a",{parentName:"li",href:"/dev-docs/error-handling"},"Error handling")," documentation."))),(0,r.kt)("br",null),(0,r.kt)("h3",{id:"custom-service-sending-an-email-to-the-restaurant-owner"},"Custom Service: Sending an email to the restaurant owner"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\ud83d\udcad Context:")),(0,r.kt)("p",null,"Out of the box, ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/strapi/foodadvisor"},"FoodAdvisor")," does not provide any automated email service feature."),(0,r.kt)("p",null,"Let's create an ",(0,r.kt)("inlineCode",{parentName:"p"},"email.js")," service file to send an email. We could use it in a ",(0,r.kt)("a",{parentName:"p",href:"#custom-controller"},"custom controller")," to notify the restaurant owner whenever a new review is created on the front-end website."),(0,r.kt)("admonition",{title:"\ud83e\udd17 Optional service",type:"callout"},(0,r.kt)("p",{parentName:"admonition"},"This service is an advanced code example using the ",(0,r.kt)("a",{parentName:"p",href:"/dev-docs/plugins/email"},"Email")," plugin and requires understanding how ",(0,r.kt)("a",{parentName:"p",href:"/dev-docs/plugins"},"plugins")," and ",(0,r.kt)("a",{parentName:"p",href:"/dev-docs/providers"},"providers")," work with Strapi. If you don't need an email service to notify the restaurant's owner, you can skip this part and jump next to the custom ",(0,r.kt)("a",{parentName:"p",href:"#custom-controller"},"controller")," example.")),(0,r.kt)(d,{mdxType:"SideBySideContainer"},(0,r.kt)(m,{mdxType:"SideBySideColumn"},(0,r.kt)("admonition",{type:"prerequisites"},(0,r.kt)("ul",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ul"},"You have setup a ",(0,r.kt)("a",{parentName:"li",href:"/dev-docs/plugins/email"},"provider for the Email plugin"),", for instance the ",(0,r.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/@strapi/provider-email-sendmail"},"Sendmail")," provider."),(0,r.kt)("li",{parentName:"ul"},"In Strapi's admin panel, you have ",(0,r.kt)("a",{parentName:"li",href:"/user-docs/content-type-builder/creating-new-content-type#creating-a-new-content-type"},"created an ",(0,r.kt)("inlineCode",{parentName:"a"},"Email")," single type")," that contains a ",(0,r.kt)("inlineCode",{parentName:"li"},"from")," Text field to define the sender email address.")))),(0,r.kt)(m,{mdxType:"SideBySideColumn"},(0,r.kt)("figure",{style:{width:"100%",margin:"0"}},(0,r.kt)("img",{src:"/img/assets/backend-customization/tutorial-single-type.png",alt:"Email Single Type in Admin Panel"}),(0,r.kt)("em",null,(0,r.kt)("figcaption",{style:{fontSize:"12px"}},'An Email single type has been created in the admin panel. It contains a "from" field used to define the sender address for the Email plugin.'))))),(0,r.kt)(d,{mdxType:"SideBySideContainer"},(0,r.kt)(m,{mdxType:"SideBySideColumn"},(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\ud83c\udfaf Goals"),":"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},'Create a new service file for the "Email" single type,'),(0,r.kt)("li",{parentName:"ul"},"Declare a ",(0,r.kt)("inlineCode",{parentName:"li"},"send()")," method for this service,"),(0,r.kt)("li",{parentName:"ul"},"Grab the sender address stored in the Email single type using the Entity Service API,"),(0,r.kt)("li",{parentName:"ul"},"Use email details (recipient's address, subject, and email body) passed when invoking the service's ",(0,r.kt)("inlineCode",{parentName:"li"},"send()")," method to send an email using the Email plugin and a previously configured provider."))),(0,r.kt)(m,{mdxType:"SideBySideColumn"},(0,r.kt)(u,{title:"Related concepts",mdxType:"SubtleCallout"},(0,r.kt)("p",null,"Additional information can be found in the ",(0,r.kt)("a",{parentName:"p",href:"/dev-docs/backend-customization/services"},"Services"),", ",(0,r.kt)("a",{parentName:"p",href:"/dev-docs/api/entity-service"},"Entity Service API"),", ",(0,r.kt)("a",{parentName:"p",href:"/dev-docs/plugins/email"},"Email plugin")," and ",(0,r.kt)("a",{parentName:"p",href:"/dev-docs/providers"},"Providers")," documentation.")))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\ud83e\uddd1\u200d\ud83d\udcbb Code example:")),(0,r.kt)("p",null,"To create such a service, in the ",(0,r.kt)("inlineCode",{parentName:"p"},"/api")," folder of the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/strapi/foodadvisor"},"FoodAdvisor")," project, create a new ",(0,r.kt)("inlineCode",{parentName:"p"},"src/api/email/services/email.js")," file with the following code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="src/api/email/services/email.js"',title:'"src/api/email/services/email.js"'},"\nconst { createCoreService } = require('@strapi/strapi').factories;\n\nmodule.exports = createCoreService('api::email.email', ({ strapi }) => ({\n  async send({ to, subject, html }) {\n    /**\n     * Retrieves email configuration data\n     * stored in the Email single type\n     * using the Entity Service API.\n     */\n    const emailConfig = await strapi.entityService.findOne(\n      'api::email.email',\n      1\n    );\n\n    /**\n     * Sends an email using:\n     * - parameters to pass when invoking the service\n     * - the 'from' address previously retrieved with the email configuration\n     */\n    await strapi.plugins['email'].services.email.send({\n      to,\n      subject,\n      html,\n      from: emailConfig.from,\n    });\n  },\n}));\n")),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"In a controller's code, the ",(0,r.kt)("inlineCode",{parentName:"p"},"send")," method from this email service can be called with ",(0,r.kt)("inlineCode",{parentName:"p"},"strapi.service('api::email.email).send(parameters)")," where ",(0,r.kt)("inlineCode",{parentName:"p"},"parameters")," is an object with the email's related information (recipient's address, subject, and email body).")),(0,r.kt)("br",null),(0,r.kt)("h3",{id:"custom-controller"},"Custom controller"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\ud83d\udcad Context:")),(0,r.kt)("p",null,"By default, controllers files in Strapi includes basic boilerplate code that use the ",(0,r.kt)("inlineCode",{parentName:"p"},"createCoreController")," factory function. This exposes basic methods to create, retrieve, update, and delete content when reaching the requested endpoint. The default code for the controllers can be customized to perform any business logic."),(0,r.kt)("p",null,'Let\'s customize the default controller for the "Reviews" collection type of ',(0,r.kt)("a",{parentName:"p",href:"https://github.com/strapi/foodadvisor"},"FoodAdvisor")," with the following scenario: upon a ",(0,r.kt)("inlineCode",{parentName:"p"},"POST")," request to the ",(0,r.kt)("inlineCode",{parentName:"p"},"/reviews")," endpoint, the controller calls previously created services to both ",(0,r.kt)("a",{parentName:"p",href:"#custom-service-creating-a-review"},"create a review")," and ",(0,r.kt)("a",{parentName:"p",href:"#custom-service-sending-an-email-to-the-restaurant-owner"},"send an email")," to the restaurant's owner."),(0,r.kt)(d,{mdxType:"SideBySideContainer"},(0,r.kt)(m,{mdxType:"SideBySideColumn"},(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\ud83c\udfaf Goals"),":"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},'Extend the existing controller for the "Reviews" collection type.'),(0,r.kt)("li",{parentName:"ul"},"Declare a custom ",(0,r.kt)("inlineCode",{parentName:"li"},"create()")," method."),(0,r.kt)("li",{parentName:"ul"},"Call previously created service(s)."),(0,r.kt)("li",{parentName:"ul"},"Sanitize the content to be returned."))),(0,r.kt)(m,{mdxType:"SideBySideColumn"},(0,r.kt)(u,{title:"Related concept",mdxType:"SubtleCallout"},(0,r.kt)("p",null,"Additional information can be found in the ",(0,r.kt)("a",{parentName:"p",href:"/dev-docs/backend-customization/controllers"},"controllers")," documentation.")))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\ud83e\uddd1\u200d\ud83d\udcbb Code example:")),(0,r.kt)("p",null,"In the ",(0,r.kt)("inlineCode",{parentName:"p"},"/api")," folder of the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/strapi/foodadvisor"},"FoodAdvisor")," project, replace the content of the ",(0,r.kt)("inlineCode",{parentName:"p"},"src/api/review/controllers/review.js")," file with one of the following code examples, depending on whether you previously created just ",(0,r.kt)("a",{parentName:"p",href:"#custom-service-creating-a-review"},"one custom service")," or both custom services for the review creation and the ",(0,r.kt)("a",{parentName:"p",href:"#custom-service-sending-an-email-to-the-restaurant-owner"},"email notification"),":"),(0,r.kt)(h,{mdxType:"Tabs"},(0,r.kt)(v,{value:"create-only",label:"Custom controller without email service",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="src/api/review/controllers/review.js"',title:'"src/api/review/controllers/review.js"'},"\nconst { createCoreController } = require('@strapi/strapi').factories;\n\nmodule.exports = createCoreController('api::review.review', ({ strapi }) => ({\n  /**\n   * As the controller action is named\n   * exactly like the original `create` action provided by the core controller, \n   * it overwrites it.\n   */\n  async create(ctx) {\n    // Creates the new review using a service\n    const newReview = await strapi.service('api::review.review').create(ctx);\n\n    const sanitizedReview = await this.sanitizeOutput(newReview, ctx);\n\n    ctx.body = sanitizedReview;\n  },\n}));\n"))),(0,r.kt)(v,{value:"create-and-email",label:"Custom controller with email service",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="src/api/review/controllers/review.js"',title:'"src/api/review/controllers/review.js"'},"\nconst { createCoreController } = require('@strapi/strapi').factories;\n\nmodule.exports = createCoreController('api::review.review', ({ strapi }) => ({\n  /**\n   * As the controller action is named\n   * exactly like the original `create` action provided by the core controller, \n   * it overwrites it.\n   */\n  async create(ctx) {\n    // Creates the new review using a service\n    const newReview = await strapi.service('api::review.review').create(ctx);\n\n    // Sends an email to the restaurant's owner, using another service\n    if (newReview.restaurant?.owner) {\n      await strapi.service('api::email.email').send({\n        to: newReview.restaurant.owner.email,\n        subject: 'You have a new review!',\n        html: `You've received a ${newReview.note} star review: ${newReview.content}`,\n      });\n    }\n\n    const sanitizedReview = await this.sanitizeOutput(newReview, ctx);\n\n    ctx.body = sanitizedReview;\n  },\n}));\n")))),(0,r.kt)("br",null),(0,r.kt)("p",null,":::strapi What's next?\nLearn more about how ",(0,r.kt)("a",{parentName:"p",href:"/dev-docs/backend-customization/examples/policies"},"custom policies")," can help you tweak a Strapi-based application and restrict access to some resources based on specific conditions.\n:::"))}f.isMDXComponent=!0}}]);